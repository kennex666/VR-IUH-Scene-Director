(()=>{window.onload=function(){window.__cam=document.querySelector("#cam"),handleTabModify();let t=document.querySelector(".btn-add-location"),e=document.querySelector(".submenu");t&&e&&t.addEventListener("click",()=>{e.classList.toggle("hidden")}),handleCloseSlideBar();let o=document.querySelector("a-scene");o.hasLoaded?(console.log("Scene has already loaded"),messenger&&messenger.start()):o.addEventListener("loaded",()=>{console.log("Scene loaded event fired"),messenger&&messenger.start()})};AFRAME.components["look-controls"].Component.prototype.onTouchMove=function(t){this.touchStarted&&this.data.touchEnabled&&setTimeout(()=>{this.pitchObject.rotation.x+=Math.PI*(t.touches[0].pageY-this.touchStart.y)/this.el.sceneEl.canvas.clientHeight*.5,this.yawObject.rotation.y+=Math.PI*(t.touches[0].pageX-this.touchStart.x)/this.el.sceneEl.canvas.clientWidth*.3,this.pitchObject.rotation.x=Math.max(Math.PI/-2,Math.min(Math.PI/2,this.pitchObject.rotation.x)),this.touchStart={x:t.touches[0].pageX,y:t.touches[0].pageY}},150)};AFRAME.registerComponent("custom-look",{init:function(){let t=this.el;t.addEventListener("update-xy",function(e){let o=t.components["look-controls"];o&&(o.pitchObject.rotation.x=e.detail.x,o.yawObject.rotation.y=e.detail.y)})},getCurrentRotation:function(){let t=this.el.components["look-controls"];if(t)return{x:t.pitchObject.rotation.x,y:t.yawObject.rotation.y}}});AFRAME.registerComponent("handle-drag-and-drop",{schema:{axis:{type:"string",default:"x"},targetEl:{type:"selector",default:"#targetBox"}},init:function(){let t=this.el,e=this.data;this.isHolding=!1,this.isHoldThisObject=!1,this.targetEl=e.targetEl,this.handleMovement(t)},handleMovement:function(t){t.addEventListener("mouseenter",e=>{this.el.parentElement.getAttribute("visible")&&(window.__holdingAxis&&window.__holdingAxis!==this.data.axis||window.__holdingTarget&&window.__holdingTarget!==this.el||(this.isHoldThisObject=!0,window.__cam.components["look-controls"].pause(),window.__holdingAxis=this.data.axis,window.__holdingTarget=this.el))}),window.addEventListener("mousemove",e=>{if(!(window.__holdingAxis&&window.__holdingAxis!==this.data.axis)&&!(window.__holdingTarget&&window.__holdingTarget!==this.el)&&this.isHoldThisObject&&this.isHolding){let{xDirect:o,yDirect:n,zDirect:a}=this.handleXYZMovement(),{x:s,y:i,z:l}=this.targetEl.getAttribute("position");this.data.axis==="x"?this.targetEl.setAttribute("position",{x:s+e.movementX*.01*o,y:i,z:l}):this.data.axis==="y"?this.targetEl.setAttribute("position",{x:s,y:i-e.movementY*.01*n,z:l}):this.data.axis==="z"&&this.targetEl.setAttribute("position",{x:s,y:i,z:l-(e.movementY*.01+e.movementX*.01*a)});let r=this.targetEl.getAttribute("position");document.dispatchEvent(new CustomEvent("position-change",{detail:{id:this.targetEl.id,x:r.x,y:r.y,z:r.z}}))}}),window.addEventListener("mouseup",e=>{this.isHolding=!1,this.isHoldThisObject=!1,window.__cam.components["look-controls"].play(),window.__holdingAxis=null,window.__holdingTarget=null}),window.addEventListener("mousedown",e=>{this.isHolding=!0})},getCurrentCameraDirection:function(){let t=document.querySelector("#cam"),e=new THREE.Vector3;return t.object3D.getWorldDirection(e),e},getCameraRotation:function(){return document.querySelector("#cam").getAttribute("rotation")},handleXYZMovement:function(){let t=this.getCurrentCameraDirection();return{xDirect:this.getCameraRotation().y>=90?-1:1,yDirect:1,zDirect:t.x>=0?1:-1}}});function u({id:t,rotation:e,axis:o,color:n}){let a=document.createElement("a-entity");a.setAttribute("handle-drag-and-drop",`axis: ${o}; targetEl: #${t}`),a.setAttribute("class","axis"),a.setAttribute("rotation",e);let s=document.createElement("a-entity");s.setAttribute("geometry","primitive: cylinder; radius: 0.005; height: 1.2"),s.setAttribute("position","0 0.6 0"),s.setAttribute("material",`color: ${n}`),s.setAttribute("class","axis");let i=document.createElement("a-entity");return i.setAttribute("geometry","primitive: cone; radiusBottom: 0.06; height: 0.2"),i.setAttribute("position","0 1.3 0"),i.setAttribute("material",`color: ${n}`),i.setAttribute("class","axis"),a.appendChild(s),a.appendChild(i),a}function d(t="targetBox",e="0 1.25 -3"){let o=document.getElementById(t);if(!o)return console.error(`Element with id "${t}" not found.`),!1;o.setAttribute("position",e),o.setAttribute("rotation","0 0 0");let n=document.createElement("a-entity");return n.setAttribute("class","axis-helper"),n.appendChild(u({id:t,axis:"x",color:"#ff4444",rotation:"0 0 -90"})),n.appendChild(u({id:t,axis:"y",color:"#44ff44",rotation:"0 0 0"})),n.appendChild(u({id:t,axis:"z",color:"#4444ff",rotation:"90 0 0"})),n.setAttribute("visible",!1),o.appendChild(n),!0}AFRAME.registerComponent("axis-helper",{init:function(){let t=this.el;d(t.id),this.isSelected=!1}});AFRAME.registerComponent("axis-selector",{init:function(){let t=this.el,e=t.parentElement;t.addEventListener("click",o=>{console.log("Click axis selector");let n=e.querySelector(".axis-helper");if(console.log("Group axis:",t),n){let a=!n.getAttribute("visible");n.setAttribute("visible",a);let s=n.querySelectorAll(".axis");if(a){if(window.__selectTargetId){let i=window.__selectTargetId;i.querySelectorAll(".axis").forEach(r=>{r.classList.toggle("clickable",!1)}),setTimeout(()=>{i.setAttribute("visible",!1)},0)}window.__selectTargetId=n,s.forEach(i=>{i.classList.toggle("clickable",!0)}),openCustomValuePop(),setCustomObjectTab(e.id,{posX:e.getAttribute("position").x,posY:e.getAttribute("position").y,posZ:e.getAttribute("position").z,rotX:e.getAttribute("rotation").x,rotY:e.getAttribute("rotation").y,rotZ:e.getAttribute("rotation").z,scaleX:e.getAttribute("scale").x,scaleY:e.getAttribute("scale").y,scaleZ:e.getAttribute("scale").z})}else window.__selectTargetId=null,s.forEach(i=>{i.classList.toggle("clickable",!1)})}})}});var c=new TabMessenger("scene");c.start=function(){c.on("LOAD_SCENE",t=>{loadScene(t.data)}),c.send("SCENE_READY",{version:"1.0.0",fps:60}),c.on("LOAD_DATA",t=>{console.log("LOAD_DATA",t),t.data&&(console.log("data load:",t.data),loadScene(t.data.scene),loadLocations(t.data.locations||[]),loadHotspots(t.data.hotspots||[]))}),window.addEventListener("beforeunload",()=>{c.send("SCENE_CLOSED")})};document.addEventListener("add-hotspot",t=>{let e=t.detail,o=createAxisEntity(e);document.querySelector("a-scene").appendChild(o),setTimeout(()=>{findHotspot(e.id)},300)});})();
